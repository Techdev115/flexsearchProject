"use strict";import"./serialize.js";import"./where.js";import Cache from"./cache.js";import Worker from"./worker.js";import presets from"./presets.js";import{encode as default_encoder,split as default_split}from"./lang/latin/index.js";import{addWorker}from"./worker.js";import{is_undefined,is_string,is_array,is_function,is_object,get_keys,create_object,create_object_array,replace,regex}from"./common.js";const defaults={encode:default_encoder,tokenize:"strict",split:default_split,cache:!1,async:!1,worker:!1,rtl:!1,doc:!1,resolution:9,threshold:0,depth:0};let id_counter=0;const global_lang={};export default function FlexSearch(a){if(!(this instanceof FlexSearch))return new FlexSearch(a);const b=a&&a.id;this.id=b||0===b?b:id_counter++,this.init(a),register_property(this,"index",function(){return get_keys(this._ids)}),register_property(this,"length",function(){return this.index.length})}FlexSearch.registerCharset=function(a,b,c,d){const e=global_lang[a]||(global_lang[a]={});return e.encoder=b,e.split=c,e.rtl=d,FlexSearch},FlexSearch.registerLanguage=function(a,b,c,d){const e=global_lang[a]||(global_lang[a]={});return e.filter=b,e.stemmer=c,e.matcher=d,FlexSearch},FlexSearch.prototype.init=function(a){this.matcher=[];let b,c;if(is_string(a)?(!1,a=presets[a]):(b=a.preset)&&(!1,a=Object.assign({},presets[b],a)),this.encoder||(a?a=Object.assign({},defaults,a):a=defaults),a){if(b=a.worker){if("undefined"==typeof Worker)a.worker=!1,this._worker=null;else{const c=parseInt(b,10)||4;this._current_task=-1,this._task_completed=0,this._task_result=[],this._current_callback=null,this._worker=Array(c);for(let b=0;b<c;b++)this._worker[b]=addWorker(this.id,b,a,this.worker_handler)}this.worker=b}const d=a.charset,e=a.lang;this.tokenizer=a.tokenize,this.split=is_string(b=d||a.split)?global_lang[b]?global_lang[b].split:regex(b):b,this.rtl=is_string(b=d||a.rtl)?global_lang[b].rtl:b,this.async=a.async,this._timer=0,this.threshold=a.threshold,this.resolution=(b=a.resolution)<=this.threshold?this.threshold+1:b,this.depth="strict"===this.tokenizer&&a.depth||0,this.encoder=is_string(b=d||a.encode)?global_lang[-1===b.indexOf(":")?b+":default":b].encode:b,this.matcher=(b=e||a.matcher)&&init_matcher(is_string(b)?global_lang[b].matcher:b),this.filter=(b=e||a.filter)&&init_filter(is_string(b)?global_lang[b].filter:b),this.stemmer=(b=e||a.stemmer)&&init_stemmer(is_string(b)?global_lang[b].stemmer:b),this.doc=c=(b=a.doc)&&clone_object(b),c&&(a.doc=null)}if(this._map=create_object_array(this.resolution-(this.threshold||0)),this._ctx=create_object(),this._ids={},c){this._doc=create_object();const b=c.index={},d=c.keys=[];let e=c.field,f=c.tag,g=c.store;if(is_array(c.id)||(c.id=c.id.split(":")),g){let a=create_object();if(is_string(g))a[g]=1;else if(is_array(g))for(let b=0;b<g.length;b++)a[g[b]]=1;else is_object(g)&&(a=g);c.store=a}if(f){this._tag=create_object();let b=create_object();if(e)if(is_string(e))b[e]=a;else if(is_array(e))for(let c=0;c<e.length;c++)b[e[c]]=a;else is_object(e)&&(b=e);is_array(f)||(c.tag=f=[f]);for(let a=0;a<f.length;a++)this._tag[f[a]]=create_object();this._tags=f,e=b}if(e){let f;is_array(e)||(is_object(e)?(f=e,c.field=e=get_keys(e)):c.field=e=[e]);for(let c=0;c<e.length;c++){const g=e[c];is_array(g)||(f&&(a=f[g]),d[c]=g,e[c]=g.split(":")),b[g]=new FlexSearch(a)}}}return(b=a.cache)&&(this._cache_status=!0,this._cache=new Cache(b)),this};function clone_object(a){const b=create_object();for(const c in a)if(a.hasOwnProperty(c)){const d=a[c];b[c]=is_array(d)?d.slice(0):is_object(d)?clone_object(d):d}return b}function init_matcher(a){const b=get_keys(a),c=b.length,d=Array(2*c);for(let e=0,f=0;e<c;e++){const c=b[e];d[f++]=regex(c),d[f++]=a[c]}return d}FlexSearch.prototype.add=function(b,a,c,d,e){if(this.doc&&is_object(b))return this.handle_docs("add",b,a);if(a&&is_string(a)&&(b||0===b)){const f=b;if(this._ids[f]&&!d)return this.update(b,a);if(!e){if(this.async&&"function"!=typeof importScripts){let e=this;const f=new Promise(function(c){setTimeout(function(){e.add(b,a,null,d,!0),e=null,c()})});if(c)f.then(c);else return f;return this}if(c)return this.add(b,a,null,d,!0),c(),this}if(a=this.encode(a),!a.length)return this;const g=this.tokenize(a),h=create_object();h._ctx=create_object();const j=g.length,k=this.threshold,l=this.depth,m=this.resolution,n=this._map,o=this.rtl;for(let a=0;a<j;a++){const c=g[a];if(c){const d=c.length,e=(o?a+1:j-a)/j;let f="";switch(this.tokenizer){case"reverse":case"both":for(let g=d;--g;)f=c[g]+f,add_index(n,h,f,b,o?1:(d-g)/d,e,k,m-1);f="";case"forward":for(let g=0;g<d;g++)f+=c[g],add_index(n,h,f,b,o?(g+1)/d:1,e,k,m-1);break;case"full":for(let a=0;a<d;a++){const g=(o?a+1:d-a)/d;for(let i=d;i>a;i--)f=c.substring(a,i),add_index(n,h,f,b,g,e,k,m-1)}break;default:const i=add_index(n,h,c,b,1,e,k,m-1);if(l&&1<j&&i>=k){const d=h._ctx[c]||(h._ctx[c]=create_object()),e=this._ctx[c]||(this._ctx[c]=create_object_array(m-(k||0)));let f=a-l,i=a+l+1;for(0>f&&(f=0),i>j&&(i=j);f<i;f++)f!==a&&add_index(e,d,g[f],b,0,m-(f<a?a-f:f-a),k,m-1)}}}}this._ids[f]=1,this._cache_status=!1}return this},FlexSearch.prototype.handle_docs=function(a,b,c){if(is_array(b)){let d=b.length;if(d--){for(let c=0;c<d;c++)this.handle_docs(a,b[c]);return this.handle_docs(a,b[d],c)}}else{const d=this.doc.index,e=this.doc.keys,f=this.doc.tag,g=this.doc.store;let h,i;h=this.doc.id;let j=b;for(let a=0;a<h.length;a++)j=j[h[a]];if("remove"===a){delete this._doc[j];let a=e.length;if(a--){for(let b=0;b<a;b++)d[e[b]].remove(j);return d[e[a]].remove(j,c)}}if(f){let a,c;for(let d=0;d<f.length;d++){a=f[d],c=b;const e=a.split(":");for(let b=0;b<e.length;b++)c=c[e[b]];c="@"+c}i=this._tag[a],i=i[c]||(i[c]=[])}h=this.doc.field;for(let f=0,g=h.length;f<g;f++){const i=h[f];let k=b;for(let a=0;a<i.length;a++)k=k[i[a]];const l=d[e[f]];"add"===a?l.add(j,k,f===g-1&&c):l.update(j,k,f===g-1&&c)}if(g){const a=get_keys(g);let c=create_object();for(let d,e=0;e<a.length;e++)if(d=a[e],g[d]){const e=d.split(":");let f,g;for(let d=0;d<e.length;d++){const a=e[d];f=(f||b)[a],g=(g||c)[a]=f}}b=c}i&&(i[i.length]=b),this._doc[j]=b}return this},FlexSearch.prototype.update=function(a,b,c){if(this.doc&&is_object(a))return this.handle_docs("update",a,b);return this._ids[a]&&is_string(b)&&(this.remove(a),this.add(a,b,c,!0)),this},FlexSearch.prototype.remove=function(a,b,c){if(this.doc&&is_object(a))return this.handle_docs("remove",a,b);const d=a;if(this._ids[d]){if(!c){if(this.async&&"function"!=typeof importScripts){let c=this;const d=new Promise(function(b){setTimeout(function(){c.remove(a,null,!0),c=null,b()})});if(b)d.then(b);else return d;return this}if(b)return this.remove(a,null,!0),b(),this}for(let b=0;b<this.resolution-(this.threshold||0);b++)remove_index(this._map[b],a);this.depth&&remove_index(this._ctx,a),delete this._ids[d],this._cache_status=!1}return this};let field_to_sort;function enrich_documents(a,b){const c=a.length,d=Array(c);for(let e=0;e<c;e++)d[e]=b[a[e]];return d}FlexSearch.prototype.merge_and_sort=function(a,b,c,d,e,f,g,h,i,j){c=intersect(c,g?0:e,h,f,b,i,j);let k;return h&&(h=c.page,k=c.next,c=c.result),c=g?this.where(g,null,e,c):enrich_documents(c,this._doc),d&&(!is_function(d)&&(field_to_sort=d.split(":"),1<field_to_sort.length?d=sort_by_deep_field_up:(field_to_sort=field_to_sort[0],d=sort_by_field_up)),c.sort(d)),c=create_page(h,k,c),this._cache&&this._cache.set(a,c),c},FlexSearch.prototype.search=function(b,c,d,e){if(is_object(c)){if(is_array(c))for(let a=0;a<c.length;a++)c[a].query=b;else c.query=b;b=c,c=1000}else c&&is_function(c)?(d=c,c=1000):c||0===c||(c=1000);let f,g,h,i,j=[],k=b;if(!is_object(b)||is_array(b)||(!d&&(d=b.callback,d&&(k.callback=null)),h=b.sort,g=b.page,c=b.limit,f=b.threshold,i=b.suggest,b=b.query),this.doc){const a=this.doc.index,e=k.where,f=k.bool||"or";let l,m,n,o=k.field,p=f;if(o)is_array(o)||(o=[o]);else if(is_array(k)){l=k,o=[],p=[];for(let a=0;a<k.length;a++){const b=k[a],c=b.bool||f;o[a]=b.field,p[a]=c,"not"===c?m=!0:"and"===c&&(n=!0)}}else o=this.doc.keys;const q=o.length;for(let b=0;b<q;b++)l&&(k=l[b]),g&&!is_string(k)&&(k.page=null,k.limit=0),j[b]=a[o[b]].search(k,0);if(d)return d(this.merge_and_sort(b,p,j,h,c,i,e,g,n,m));if(this.async){const a=this;return new Promise(function(d){Promise.all(j).then(function(f){d(a.merge_and_sort(b,p,f,h,c,i,e,g,n,m))})})}return this.merge_and_sort(b,p,j,h,c,i,e,g,n,m)}if(f||(f=this.threshold||0),!e){if(this.async&&"function"!=typeof importScripts){let a=this;const b=new Promise(function(b){setTimeout(function(){b(a.search(k,c,null,!0)),a=null})});if(d)b.then(d);else return b;return this}if(d)return d(this.search(k,c,null,!0)),this}if(!b||!is_string(b))return j;if(k=b,this._cache)if(this._cache_status){const a=this._cache.get(b);if(a)return a}else this._cache.clear(),this._cache_status=!0;if(k=this.encode(k),!k.length)return j;const l=this.tokenize(k),m=l.length;let n=!0;const o=[],p=create_object();let q,r,s=0;1<m&&(this.depth?r=!0:l.sort(sort_by_length_down));let t;if(!r||(t=this._ctx))for(const a=this.resolution;s<m;s++){let b=l[s];if(b){if(r){if(!q)if(t[b])q=b,p[b]=1;else if(!i)return j;if(i&&s==m-1&&!o.length)r=!1,b=q||b,p[b]=0;else if(!q)continue}if(!p[b]){const c=[];let d=!1,e=0;const g=r?t[q]:this._map;if(g){let h;for(let i=0;i<a-f;i++)(h=g[i]&&g[i][b])&&(c[e++]=h,d=!0)}if(d)q=b,o[o.length]=1<e?c.concat.apply([],c):c[0];else if(!i){n=!1;break}p[b]=1}}}else n=!1;return n&&(j=intersect(o,c,g,i)),this._cache&&this._cache.set(b,j),j},FlexSearch.prototype.info=function(){return{id:this.id,items:this.length,matcher:this.matcher.length,worker:this.worker,threshold:this.threshold,depth:this.depth,resolution:this.resolution,contextual:this.depth&&"strict"===this.tokenizer}},FlexSearch.prototype.clear=function(){return this.destroy().init()},FlexSearch.prototype.destroy=function(){if(this._cache&&(this._cache.clear(),this._cache=null),this._map=this._ctx=this._ids=null,this.doc){const a=this.doc.keys;for(let b=0;b<a.length;b++)this.doc.index[a[b]].destroy();this.doc=this._doc=null}return this};function register_property(a,b,c){Object.defineProperty(a,b,{get:c})}function add_index(a,b,c,d,e,f,g,h){if(b[c])return b[c];const i=e?(h-(g||h/1.5))*f+(g||h/1.5)*e:f;if(b[c]=i,i>=g){let b=a[h-(i+0.5>>0)];b=b[c]||(b[c]=[]),b[b.length]=d}return i}function remove_index(b,c){if(b){const a=get_keys(b);for(let d=0,e=a.length;d<e;d++){const e=a[d],f=b[e];if(f)for(let d=0,a=f.length;d<a;d++)if(f[d]===c){1===a?delete b[e]:f.splice(d,1);break}else is_object(f[d])&&remove_index(f[d],c)}}}FlexSearch.prototype.encode=function(a){return a&&this.encoder&&(a=this.encoder(a)),a&&this.matcher.length&&(a=replace(a,this.matcher)),a&&this.stemmer&&(a=replace(a,this.stemmer)),a},FlexSearch.prototype.tokenize=function(a){let b=is_array(a)?a:is_function(this.tokenizer)?this.tokenizer(a):a.split(this.split);return this.filter&&(b=filter_words(b,this.filter)),b};function filter_words(a,b){const c=a.length,d=is_function(b),e=[];for(let f=0,g=0;f<c;f++){const c=a[f];c&&(d&&b(c)||!d&&!b[c])&&(e[g++]=c)}return e}function init_filter(a){const b=create_object();for(let c=0;c<a.length;c++){const d=a[c];b[d]=1}return b}function init_stemmer(a){const b=Object.keys(a),c=b.length,d=Array(2*c);for(let e=0,f=0;e<c;e++){const c=b[e];d[f++]=regex(c+"(?!\\b)"+c+"(\\b)"),d[f++]=a[c]}return d}function sort_by_length_down(c,a){return a.length-c.length}function sort_by_field_up(c,a){return c[field_to_sort]-a[field_to_sort]}function sort_by_deep_field_up(c,d){const e=field_to_sort.length;for(let a=0;a<e;a++)c=c[field_to_sort[a]],d=d[field_to_sort[a]];return c-d}function create_page(a,b,c){return a?{page:a,next:b?""+b:null,result:c}:c}function intersect(a,b,c,d,e,f,g){let h,j,k=[];!0===c?(c="0",j=""):j=c&&c.split(":");const l=a.length;if(1<l){const m=create_object(),n=[];let o,p,q,r,s,t,u,v,w,x=0,y=0,i=!0,z=0;if(j&&(2===j.length?(v=j,j=!1):j=w=parseInt(j[0],10)),g){for(o=create_object();x<l;x++)if("not"===e[x])for(p=a[x],q=p.length,y=0;y<q;y++)o["@"+p[y]]=1;else u=x+1;if(is_undefined(u))return create_page(c,h,k);x=0}else t=is_string(e)&&e;for(let v,A;x<l;x++){const B=x===(u||l)-1;if(!t||!x){const a=t||e&&e[x];if(!a||"and"===a)v=f=!0,A=!1;else if("or"===a)A=!0,v=!1;else continue}if(p=a[x],q=p.length,!q){if(v&&!d)return create_page(c,h,p);continue}if(i)if(s){const a=s.length;for(y=0;y<a;y++){const a=s[y],b="@"+a;g&&o[b]||(m[b]=1,!f&&(k[z++]=a))}s=null,i=!1}else{s=p;continue}let C=!1;for(y=0;y<q;y++){r=p[y];const a="@"+r,e=f?m[a]||0:x;if(e||d){if(g&&o[a])continue;if(!f&&m[a])continue;if(e===x){if(!B)m[a]=x+1;else if((!w||--w<z)&&(k[z++]=r,b&&z===b))return create_page(c,z+(j||0),k);C=!0}else if(d){const a=n[e]||(n[e]=[]);a[a.length]=r}}}if(v&&!C&&!d)break}if(s){const a=s.length;if(g)for(y=j?parseInt(j,10):0;y<a;y++){const a=s[y];o["@"+a]||(k[z++]=a)}else k=s}if(d)for(z=k.length,v?(x=parseInt(v[0],10)+1,y=parseInt(v[1],10)+1):(x=n.length,y=0);x--;)if(r=n[x],r){for(q=r.length;y<q;y++){const a=r[y];if((!g||!o["@"+a])&&(k[z++]=a,b&&z===b))return create_page(c,x+":"+y,k)}y=0}}else l&&(e&&"not"===e[0]||(k=a[0],j&&(j=parseInt(j[0],10))));if(b){const a=k.length;j&&j>a&&(j=0);const c=j||0;h=c+b,h<a?k=k.slice(c,h):(h=0,c&&(k=k.slice(c)))}return create_page(c,h,k)}